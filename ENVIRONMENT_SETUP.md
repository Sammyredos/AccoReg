# Environment Setup Guide

This guide explains how to set up AccoReg for both local development and production deployment.

## Overview

AccoReg is designed to work seamlessly in both local and production environments:

- **Local Development**: Uses SQLite database for simplicity
- **Production**: Uses PostgreSQL database for scalability and reliability

## Quick Setup

### Local Development

1. **Clone and install dependencies:**
   ```bash
   git clone <repository-url>
   cd AccoReg
   npm install
   ```

2. **Set up development environment:**
   ```bash
   npm run setup:dev
   ```

3. **Start development server:**
   ```bash
   npm run dev
   ```

4. **Access the application:**
   - Main app: http://localhost:3000
   - Admin panel: http://localhost:3000/admin
   - Health check: http://localhost:3000/api/health

### Production Deployment

The application is configured for automatic deployment on Render.com:

1. **Deploy to Render:**
   - Connect your repository to Render
   - The `render.yaml` file contains all necessary configuration
   - Environment variables are automatically configured

2. **Manual production setup:**
   ```bash
   NODE_ENV=production npm run setup:prod
   npm run build
   npm start
   ```

## Environment Configuration

### Development Environment Variables

Create a `.env.local` file (automatically created by `npm run setup:dev`):

```env
NODE_ENV=development
DATABASE_URL="file:./dev.db"
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=<auto-generated>
JWT_SECRET=<auto-generated>
RATE_LIMIT_ENABLED=false
LOG_LEVEL=debug
CSP_ENABLED=false
HSTS_ENABLED=false
```

### Production Environment Variables

Required for production deployment:

```env
NODE_ENV=production
DATABASE_URL=postgresql://user:password@host:port/database
NEXTAUTH_URL=https://your-domain.com
NEXTAUTH_SECRET=<secure-secret>
JWT_SECRET=<secure-secret>
ENCRYPTION_KEY=<secure-key>
RATE_LIMIT_ENABLED=true
LOG_LEVEL=info
CSP_ENABLED=true
HSTS_ENABLED=true
BACKUP_ENCRYPTION=true
BACKUP_ENCRYPTION_KEY=<secure-key>
```

## Database Configuration

### Local Development (SQLite)

- **Database file**: `./dev.db`
- **Schema**: `prisma/schema.dev.prisma`
- **Commands**:
  ```bash
  npm run db:generate:dev  # Generate Prisma client
  npm run db:push:dev      # Push schema changes
  npm run db:studio:dev    # Open Prisma Studio
  ```

### Production (PostgreSQL)

- **Database**: PostgreSQL instance
- **Schema**: `prisma/schema.prisma`
- **Commands**:
  ```bash
  npm run db:generate      # Generate Prisma client
  npm run db:migrate       # Run migrations
  npm run db:deploy        # Deploy migrations (production)
  npm run db:studio        # Open Prisma Studio
  ```

## Available Scripts

### Setup Scripts

- `npm run setup:dev` - Complete development environment setup
- `npm run setup:prod` - Complete production environment setup
- `npm run setup:admin` - Create super admin user only
- `npm run setup:env` - Environment-aware setup

### Database Scripts

- `npm run db:generate` - Generate Prisma client (environment-aware)
- `npm run db:push` - Push schema to database (environment-aware)
- `npm run db:migrate` - Run database migrations (environment-aware)
- `npm run db:deploy` - Deploy migrations for production
- `npm run db:studio` - Open Prisma Studio (environment-aware)

### Development Scripts

- `npm run dev` - Start development server
- `npm run build` - Build for production
- `npm run start` - Start production server
- `npm run lint` - Run ESLint
- `npm run type-check` - Run TypeScript checks

## Health Checks

The application includes comprehensive health checks accessible at `/api/health`:

### Health Check Response

```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "responseTime": "50ms",
  "checks": {
    "database": {
      "status": "pass",
      "responseTime": 25,
      "details": {
        "connected": true,
        "provider": "postgresql",
        "schema": "prisma/schema.prisma"
      }
    },
    "environment": {
      "status": "pass",
      "details": {
        "nodeEnv": "production",
        "databaseProvider": "postgresql",
        "expectedProvider": "postgresql",
        "providerMatch": true,
        "configValid": true
      }
    }
  }
}
```

## Troubleshooting

### Common Issues

1. **Database connection failed**
   - Check DATABASE_URL format
   - Ensure database server is running
   - Verify credentials and permissions

2. **Environment validation failed**
   - Check required environment variables
   - Verify database provider matches environment
   - Review startup logs for specific errors

3. **Prisma client not generated**
   - Run `npm run db:generate`
   - Check schema file exists
   - Verify DATABASE_URL is set

### Debug Commands

```bash
# Check environment configuration
npm run setup:env -- --skip-database --skip-admin

# Validate database connection
curl http://localhost:3000/api/health

# View detailed logs
LOG_LEVEL=debug npm run dev
```

## Security Considerations

### Development

- SQLite database file should not be committed to version control
- Use `.env.local` for local environment variables
- Disable security headers for easier development

### Production

- Use strong, unique secrets for all keys
- Enable all security headers (CSP, HSTS)
- Use encrypted backups
- Regularly rotate secrets
- Monitor health check endpoint

## Support

For issues or questions:

1. Check the health check endpoint: `/api/health`
2. Review application logs
3. Verify environment configuration
4. Check database connectivity

The application includes comprehensive startup checks that will identify most configuration issues automatically.
